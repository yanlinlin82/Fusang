# Fusang 测试方法

本文档用于说明在曙光云（超算互联网）环境下，如何启动 Fusang 容器并完成测试、结果检查和性能统计。

## 一、从镜像启动容器

1. 登录超算互联网网站：<https://www.scnet.cn/>。
2. 进入“控制台” → “容器服务” → “创建容器”。
3. 按以下方式配置：
    - 资源队列：选择带有“异构加速卡1/16GB”的队列。
    - 开发工具：选择“SSH”类型。
    - 开发镜像：选择 `fusang_6552_20260214:2.18.0-ubuntu22.04-dtk25.04.2-py3.10-devel`。
4. 若镜像不可见，先在“镜像仓库”中克隆到“我的镜像”。
5. 等待容器部署完成后，打开“控制台[E-Shell]”。

## 二、确认容器启动成功

在 E-Shell 中执行：

```sh
python /opt/fusang/fusang.py
```

若容器和程序环境正常，会打印 Fusang 的命令帮助信息（包含 `infer`、`simulate`、`train`、`evaluate` 等子命令）。

## 三、建议使用 tmux 或 screen 运行测试

测试程序耗时较长，建议在虚拟终端中运行，避免网络断开导致任务中止。

可选安装命令：

```sh
apt update
apt install -y tmux screen
```

使用 `tmux`（推荐）示例：

```sh
tmux new -s fusang-test
bash /opt/fusang/ghfund/run-all.sh
```

会话分离（任务继续运行）：按 `Ctrl+b` 后按 `d`。

会话恢复：

```sh
tmux attach -t fusang-test
```

使用 `screen` 示例：

```sh
screen -S fusang-test
bash /opt/fusang/ghfund/run-all.sh
```

## 四、执行测试

执行全部测试：

```sh
bash /opt/fusang/ghfund/run-all.sh
```

或执行单个测试：

```sh
bash /opt/fusang/ghfund/demo-1.sh
bash /opt/fusang/ghfund/demo-2.sh
bash /opt/fusang/ghfund/demo-3.sh
```

## 五、运行完成后的检查

### 1) 检查日志

查看日志目录：

```sh
ls -lh /opt/fusang/logs/
```

每个用例会生成对应日志文件，可从中看到运行起始时间、终止时间和耗时（`time` 输出）。

示例（查看某个日志）：

```sh
tail -n 50 /opt/fusang/logs/<某个日志文件>.log
```

### 2) 检查结果文件

结果目录：

```sh
ls -R /opt/fusang/results/
```

目录中通常包含成对结果，例如：`*.cpu.tree` 与 `*.dcu.tree`。

## 六、结果内容查看（treeview.py）

Fusang 输出为 Newick 格式，可用 `treeview.py` 查看树结构。

方式一：传入结果文件

```sh
python /opt/fusang/treeview.py /opt/fusang/results/<数据集名>/<文件名>.cpu.tree
```

方式二：通过管道输入

```sh
cat /opt/fusang/results/<数据集名>/<文件名>.cpu.tree | python /opt/fusang/treeview.py
```

## 七、CPU 与 DCU 结果一致性检查

可对比对应的 `cpu.tree` 与 `dcu.tree`，预期应一致。

示例：

```sh
diff /opt/fusang/results/<数据集名>/<文件名>.cpu.tree /opt/fusang/results/<数据集名>/<文件名>.dcu.tree
```

若 `diff` 无输出，表示两者一致。

## 八、性能统计说明

最终性能对比基于日志中的运行时长信息进行统计与展示。通常以同一测试集下 CPU 与 DCU 的耗时对比，给出整体性能评估结果。
