# Fusang 软件使用说明

本文档用于说明在曙光云（超算互联网）通过镜像启动容器的方式来运行 Fusang 的场景。

## 一、在超算互联网创建容器

1. 登录超算互联网网站：<https://www.scnet.cn/>。
2. 进入“控制台” → “容器服务”，点击“创建容器”。
3. 关键配置按以下选择：
   - 资源队列：选择带有“异构加速卡1/16GB”的队列。
   - 开发工具：选择“SSH”类型。
   - 开发镜像：选择 `fusang_6552_20260214:2.18.0-ubuntu22.04-dtk25.04.2-py3.10-devel`。
4. 如果镜像列表中没有该镜像，需要先在“镜像仓库”中将该镜像克隆到“我的镜像”。
5. 等待容器部署完成后，打开“控制台[E-Shell]”。

## 二、启动后基础检查

在 E-Shell 中可直接使用 Fusang 主程序：

```sh
python /opt/fusang/fusang.py
```

推荐先查看帮助信息：

```sh
python /opt/fusang/fusang.py --help
python /opt/fusang/fusang.py infer --help
python /opt/fusang/fusang.py simulate --help
python /opt/fusang/fusang.py train --help
python /opt/fusang/fusang.py evaluate --help
```

## 三、通用参数（各子命令可用）

- `-q, --quiet`：安静模式，尽量抑制警告/底层输出。
- `-v, --verbose`：详细日志模式。
- `-c, --cpu`：强制只用 CPU（禁用 DCU/GPU）。

注意：`--quiet` 与 `--verbose` 不能同时使用。

## 四、树推断（infer）

用于从单个 MSA 文件推断系统发育树（Newick 格式）。

### 1) 基本命令

```sh
python /opt/fusang/fusang.py infer -i <MSA_FILE> [-o <OUTPUT_TREE>]
```

### 2) 参数说明

- `-i, --input`（必填）：输入 MSA 文件路径。
- `-o, --output`：输出树文件路径；不填时输出到标准输出。
- `-b, --beam_size`：Beam Search 大小，默认 `1`。
- `-t, --sequence_type`：序列类型，`standard|coding|noncoding`，默认 `standard`。
- `-r, --branch_model`：分支模型，`gamma|uniform`，默认 `gamma`。
- `-w, --window_coverage`：滑窗覆盖系数，默认 `1`。

### 3) 示例

```sh
# 基础推断
python /opt/fusang/fusang.py infer \
  -i /opt/fusang/example_msa/a.fas \
  -o /opt/fusang/dl_output/tree_for_a.txt

# 强制 CPU
python /opt/fusang/fusang.py infer \
  --cpu \
  -i /opt/fusang/example_msa/a.fas \
  -o /opt/fusang/dl_output/tree_for_a.cpu.txt

# 不写文件，直接输出到终端
python /opt/fusang/fusang.py infer -i /opt/fusang/example_msa/a.fas
```

### 4) 结果展示（treeview.py）

`infer` 的输出是 Newick 格式字符串，可使用 `/opt/fusang/treeview.py` 以树形文本方式展示。

方式一：通过参数传入树文件

```sh
python /opt/fusang/treeview.py /opt/fusang/dl_output/tree_for_a.txt
```

方式二：接收管道输入

```sh
python /opt/fusang/fusang.py infer -i /opt/fusang/example_msa/a.fas -q | python /opt/fusang/treeview.py
```

## 五、模拟数据生成（simulate）

用于调用 INDELible 生成模拟数据，并整理为后续训练可用的 `numpy_data`。

### 1) 基本命令

```sh
python /opt/fusang/fusang.py simulate -o <SIM_DIR> -n <NUM_OF_TOPOLOGY> -t <TAXA_NUM>
```

### 2) 关键参数

- `-o, --output`（必填）：模拟输出目录。
- `-n, --num_of_topology`（必填）：生成的 MSA 数量。
- `-t, --taxa_num`（必填）：最终树的物种数。
- `-p, --num_of_process`：并行进程数（默认 CPU 核心数）。
- `-S, --seed`：随机种子（默认 `42`）。
- `-b, --batch_size`：并行批大小（默认 `1000`）。
- `--indelible_path`：INDELible 可执行文件路径（不填则自动探测）。
- `--no-cleanup`：完成后不删除中间目录 `simulate_data`。

### 3) 示例

```sh
python /opt/fusang/fusang.py simulate \
  -o /opt/fusang/simulation/out/demo \
  -n 20 \
  -t 10 \
  -p 8 \
  -S 42
```

## 六、模型训练（train）

使用 `numpy_data` 训练模型权重。

### 1) 基本命令

```sh
python /opt/fusang/fusang.py train -d <DATA_DIR> -o <MODEL_PATH>
```

### 2) 参数说明

- `-d, --data_dir`（必填）：
  - 可直接给 `.../numpy_data`（其中有 `seq/` 和 `label/`），或
  - 给 simulation 输出目录（其中包含 `numpy_data/seq` 和 `numpy_data/label`）。
- `-o, --output`（必填）：模型权重输出路径（建议 `.h5` / `.weights.h5`）。
- `-w, --window_size`：窗口长度，`240|1200`，默认 `240`。
- `-e, --epochs`：训练轮数，默认 `100`。
- `-b, --batch_size`：批大小，默认 `32`。
- `-r, --learning_rate`：学习率，默认 `0.001`。
- `--train_ratio`：训练集比例，默认 `0.8`。
- `--val_ratio`：验证集比例，默认 `0.1`。
- `-M, --monitor`：早停/最佳模型监控指标，默认 `val_loss`。
- `-P, --patience`：早停耐心轮数，默认 `10`；设为 `0` 表示关闭早停。

### 3) 示例

```sh
python /opt/fusang/fusang.py train \
  -d /opt/fusang/simulation/out/demo \
  -o /opt/fusang/model/my_model.weights.h5 \
  -w 240 \
  -e 30 \
  -b 32
```

## 七、模型评估（evaluate）

在 `numpy_data` 上评估已训练模型。

### 1) 基本命令

```sh
python /opt/fusang/fusang.py evaluate -m <MODEL_PATH> -d <DATA_DIR> [-o <RESULT_DIR>]
```

### 2) 参数说明

- `-m, --model`（必填）：模型权重路径（`.h5`）。
- `-d, --data_dir`（必填）：同 `train` 的数据目录规则。
- `-o, --output`：评估结果输出目录；不填则不落盘。
- `-w, --window_size`：`240|1200`；不填时尝试从模型名推断。
- `-b, --batch_size`：预测批大小，默认 `32`。

### 3) 示例

```sh
python /opt/fusang/fusang.py evaluate \
  -m /opt/fusang/model/my_model.weights.h5 \
  -d /opt/fusang/simulation/out/demo \
  -o /opt/fusang/results/eval_demo
```
